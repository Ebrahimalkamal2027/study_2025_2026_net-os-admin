---
## Author
author:
  name: Ибрахим Мохсейн Алькамаль
  degrees: Student (3 курс)
  orcid: ""
  email: 1032225432@pfur.ru
  affiliation:
    - name: Российский университет дружбы народов
      country: Российская Федерация
      postal-code: 117198
      city: Москва
      address: ул. Миклухо-Маклая, д. 6

## Title
title: "Отчёт по лабораторной работе №8"
subtitle: "Дисциплина: Администрирование сетевых подсистем"
license: "CC BY"
---

# Цель работы

Приобретение практических навыков по установке и конфигурированию SMTP-сервера.


# Выполнение лабораторной работы

## Переход в режим суперпользователя

На виртуальной машине `server` выполнен вход в терминал и переход в режим суперпользователя с использованием команды `sudo -i`, что подтверждается приглашением командной строки `root@server.alkamal.net` ([рис. @fig-1]).

![Переход в режим суперпользователя на сервере](image/1.png){#fig-1 width=70%}

## Установка пакетов Postfix и s-nail

С использованием менеджера пакетов `dnf` установлены необходимые для работы почтовой подсистемы пакеты `postfix` и `s-nail`. В выводе отображается успешное разрешение зависимостей, загрузка и установка пакетов без ошибок ([рис. @fig-2]).

![Установка пакетов postfix и s-nail с помощью dnf](image/2.png){#fig-2 width=70%}


## Настройка межсетевого экрана для службы SMTP

С помощью утилиты `firewall-cmd` разрешена работа службы `smtp` в текущей и постоянной конфигурации межсетевого экрана. Команда `--list-services` подтверждает наличие службы `smtp` в списке разрешённых сервисов ([рис. @fig-3]).

![Разрешение службы SMTP в firewalld](image/3.png){#fig-3 width=70%}

## Восстановление контекста безопасности SELinux

Выполнена команда `restorecon -vR /etc` для восстановления корректных контекстов безопасности SELinux в каталоге `/etc`. В выводе отображается изменение контекста для сетевого конфигурационного файла ([рис. @fig-3]).

![Восстановление контекста безопасности SELinux](image/3.png){#fig-3 width=70%}

## Запуск и активация службы Postfix

Служба `postfix` добавлена в автозагрузку с помощью `systemctl enable postfix` и запущена командой `systemctl start postfix`. Проверка состояния через `systemctl status postfix` показывает, что служба активна и находится в состоянии `active (running)` ([рис. @fig-4]).

![Статус службы Postfix после запуска](image/4.png){#fig-4 width=70%}

## Просмотр текущих параметров Postfix

С помощью команды `postconf` выведен полный список текущих параметров конфигурации Postfix. В выводе отображаются активные значения переменных, включая параметры проверки адресов и транспортов ([рис. @fig-5]).

![Вывод команды postconf — список текущих параметров](image/5.png){#fig-5 width=70%}

## Проверка параметров myorigin и mydomain

Команда `postconf myorigin` показала, что параметр `myorigin` имеет значение `$myhostname`.
Команда `postconf mydomain` подтвердила, что домен установлен как `alkamal.net`.
Далее выполнена команда `postconf -e 'myorigin = $mydomain'`, после чего повторная проверка `postconf myorigin` показала новое значение `$mydomain`.
Корректность конфигурации проверена командой `postfix check`, затем выполнена перезагрузка конфигурации `systemctl reload postfix`.
Команда `postconf -n` отобразила параметры, отличающиеся от значений по умолчанию, включая `myorigin = $mydomain` ([рис. @fig-6]).

![Изменение параметра myorigin и проверка конфигурации](image/6.png){#fig-6 width=70%}

## Жёсткая установка домена и отключение IPv6

Параметр домена принудительно установлен командой
`postconf -e 'mydomain = alkamal.net'`.

Проверка `postconf inet_protocols` показала, что разрешены все протоколы (`all`).
Затем выполнена команда `postconf -e 'inet_protocols = ipv4'`, в результате чего IPv6 отключён и оставлен только IPv4.

После внесения изменений выполнены команды `postfix check` и `systemctl reload postfix` для проверки и применения новой конфигурации ([рис. @fig-7]).

![Настройка параметров mydomain и inet\_protocols](image/7.png){#fig-7 width=70%}


### 1. Отправка тестового сообщения с сервера

На сервере под учётной записью `root` отправлено письмо командой
`echo . | mail -s test1 alkamal@server.alkamal.net` ([рис. @fig-8]).

![Отправка письма test1 с сервера](image/8.png){#fig-8 width=70%}

---

### Анализ журналов и локальной доставки на сервере

Выполнен мониторинг журнала `/var/log/maillog` командой `tail -f`.
В логе присутствуют строки:

* `status=sent (delivered to mailbox)`
* `removed`

Это подтверждает успешную локальную доставку сообщения в почтовый ящик пользователя ([рис. @fig-9]).

Дополнительно проверено содержимое каталога `/var/spool/mail`, где обнаружен файл пользователя `alkamal` с полученным письмом ([рис. @fig-10]).

![Мониторинг maillog при локальной отправке](image/9.png){#fig-9 width=70%}

![Содержимое почтового ящика пользователя](image/10.png){#fig-10 width=70%}

## Установка Postfix и s-nail на клиенте

На виртуальной машине `client` выполнена установка пакетов `postfix` и `s-nail` с использованием `dnf`. Установка завершена успешно ([рис. @fig-11], [рис. @fig-12]).

![Установка postfix на клиенте](image/11.png){#fig-11 width=70%}

![Установка s-nail на клиенте](image/12.png){#fig-12 width=70%}

## Настройка протоколов и запуск Postfix на клиенте

На клиенте проверено значение параметра `inet_protocols`, затем выполнено изменение на `ipv4`.
Служба Postfix добавлена в автозагрузку и запущена ([рис. @fig-13]).

![Настройка inet\_protocols и запуск Postfix на клиенте](image/13.png){#fig-13 width=70%}

## Повторная отправка письма с клиента

С клиента отправлено второе письмо командой
`echo . | mail -s test2 alkamal@server.alkamal.net` ([рис. @fig-14]).

![Отправка письма test2 с клиента](image/14.png){#fig-14 width=70%}


## Проверка сетевых параметров на сервере

На сервере просмотрены параметры:

* `inet_interfaces = localhost`
* `mynetworks = 127.0.0.1/32`

Это означает, что сервер принимал соединения только с локального интерфейса ([рис. @fig-15]).

![Просмотр параметров inet\_interfaces и mynetworks](image/15.png){#fig-15 width=70%}


## Разрешение сетевых соединений

В конфигурацию внесены изменения:

* `inet_interfaces = all`
* `mynetworks = 127.0.0.0/8, 192.168.0.0/16`

После этого выполнены `postfix check`, `systemctl reload postfix`, `systemctl stop postfix`, `systemctl start postfix` для применения изменений ([рис. @fig-15]).

![Изменение параметров сети Postfix](image/15.png){#fig-15 width=70%}


## Повторная отправка письма после изменения конфигурации

После внесения изменений письмо с клиента успешно доставлено.

В заголовках письма отображается строка:

* `Received: from client.alkamal.net (192.168.1.30)`
* `status=sent (delivered to mailbox)`

Это подтверждает успешную доставку сообщения с клиента на сервер ([рис. @fig-16], [рис. @fig-18]).

![Заголовки письма, полученного с клиента](image/16.png){#fig-16 width=70%}

![Запись в журнале о доставке письма с клиента](image/18.png){#fig-18 width=70%}

## Настройка прямой DNS-зоны с MX-записью

В файле прямой зоны `/var/named/master/fz/alkamal.net` добавлена MX-запись:

`MX 10 mail.alkamal.net.`

Также задана A-запись для узла `mail` с адресом `192.168.1.1`. Это обеспечивает маршрутизацию почты для домена `alkamal.net` через почтовый сервер `mail.alkamal.net` ([рис. @fig-19]).

![Файл прямой DNS-зоны с MX-записью](image/19.png){#fig-19 width=70%}

## Настройка обратной DNS-зоны

В файле обратной зоны `/var/named/master/rz/192.168.1` добавлены PTR-записи, сопоставляющие IP-адрес `192.168.1.1` с именами:

* `server.alkamal.net`
* `ns.alkamal.net`
* `dhcp.alkamal.net`
* `www.alkamal.net`
* `mail.alkamal.net`

Это обеспечивает корректное обратное разрешение имени почтового сервера ([рис. @fig-20]).

![Файл обратной DNS-зоны с PTR-записями](image/20.png){#fig-20 width=70%}

## Добавление домена в параметры mydestination

В конфигурацию Postfix внесено изменение:

`postconf -e 'mydestination = $myhostname, localhost.$mydomain, localhost, $mydomain'`

После этого выполнены команды `postfix check` и `systemctl reload postfix` для проверки и применения конфигурации. Также восстановлены контексты SELinux и перезапущена служба DNS `named`. Очередь отправки принудительно обработана командой `postqueue -f` ([рис. @fig-21]).

![Настройка mydestination и перезапуск служб](image/21.png){#fig-21 width=70%}

## Отправка письма на доменный адрес с клиента

С клиента отправлено письмо на доменный адрес:

`echo . | mail -s test3 alkamal@alkamal.net` ([рис. @fig-22]).

![Отправка письма на доменный адрес](image/22.png){#fig-22 width=70%}


## Проверка доставки сообщения

В журнале `/var/log/maillog` зафиксирована строка:

`status=sent (delivered to mailbox)`

Это подтверждает успешную доставку сообщения в почтовый ящик пользователя на сервере после настройки MX-записи и параметра `mydestination` ([рис. @fig-23]).

![Журнал Postfix с подтверждением доставки](image/23.png){#fig-23 width=70%}

## Копирование конфигурации DNS в каталог provision сервера

На виртуальной машине `server` выполнен переход в каталог
`/vagrant/provision/server/dns/var/named` и произведено копирование текущих файлов DNS из `/var/named` в каталог provision. В процессе подтверждена перезапись существующих файлов зоны ([рис. @fig-24]).

![Копирование файлов DNS в каталог provision](image/24.png){#fig-24 width=70%}

## Создание скрипта mail.sh на сервере

В каталоге `/vagrant/provision/server` создан исполняемый файл `mail.sh` и открыт для редактирования. В скрипт включены команды:

* установка пакетов `postfix` и `s-nail`;
* настройка firewall (служба smtp);
* восстановление контекста SELinux;
* запуск службы Postfix;
* конфигурация параметров `mydomain`, `myorigin`, `inet_protocols`, `inet_interfaces`, `mydestination`, `mynetworks`;
* применение прав `postfix set-permissions`;
* перезапуск службы.

Скрипт полностью соответствует конфигурации домена `alkamal.net` ([рис. @fig-25]).

![Содержимое mail.sh на сервере](image/25..png){#fig-25 width=70%}


## Создание скрипта mail.sh на клиенте

На виртуальной машине `client` выполнен переход в каталог
`/vagrant/provision/client`, создан и сделан исполняемым файл `mail.sh` ([рис. @fig-26]).

![Создание mail.sh на клиенте](image/26.png){#fig-26 width=70%}

В скрипте реализованы:

* установка `postfix` и `s-nail`;
* установка параметра `inet_protocols = ipv4`;
* добавление службы в автозагрузку;
* запуск Postfix.

![Содержимое mail.sh на клиенте](image/27.png){#fig-27 width=70%}


## Добавление provisioning-скрипта для сервера в Vagrantfile

В конфигурационный файл `Vagrantfile` в разделе сервера добавлен блок:

```
server.vm.provision "server mail",
  type: "shell",
  preserve_order: true,
  path: "provision/server/mail.sh"
```

Это обеспечивает автоматическое выполнение скрипта при загрузке виртуальной машины сервера ([рис. @fig-28]).

![Добавление provisioning для сервера в Vagrantfile](image/28.png){#fig-28 width=70%}

## Добавление provisioning-скрипта для клиента в Vagrantfile

В разделе конфигурации клиента добавлен аналогичный блок:

```
client.vm.provision "client mail",
  type: "shell",
  preserve_order: true,
  path: "provision/client/mail.sh"
```

Таким образом, при запуске виртуальной машины клиента автоматически выполняется настройка почтовой подсистемы ([рис. @fig-29]).

![Добавление provisioning для клиента в Vagrantfile](image/29.png){#fig-29 width=70%}

# Выводы

В ходе выполнения работы выполнена полная настройка почтовой системы на базе Postfix в домене `alkamal.net`.

На сервере настроены параметры `mydomain`, `myorigin`, `inet_interfaces`, `mynetworks`, `mydestination`, а также реализована поддержка только протокола IPv4. Настроена служба firewalld для разрешения SMTP и восстановлены контексты безопасности SELinux. Проверка журналов `/var/log/maillog` подтвердила успешную локальную и сетевую доставку сообщений (`status=sent (delivered to mailbox)`).

Добавление MX-записи в прямую DNS-зону и соответствующих PTR-записей в обратную зону обеспечило корректную маршрутизацию почты по доменному имени `alkamal.net`. После обновления конфигурации DNS и Postfix доставка сообщений на доменный адрес выполняется корректно.

Созданы provisioning-скрипты `mail.sh` для серверной и клиентской виртуальных машин, что позволило автоматизировать установку, настройку и запуск почтовой службы при загрузке через Vagrant. Таким образом, почтовая подсистема интегрирована в механизм автоматической конфигурации виртуального окружения.


# Ответы на контрольные вопросы

1. В каком каталоге и в каком файле следует смотреть конфигурацию Postfix?

- Конфигурация Postfix обычно хранится в файле `main.cf`, а путь к
этому файлу может различаться в разных системах. Однако, обычно
он находится в каталоге `/etc/postfix/`. Таким образом, путь к файлу
конфигурации будет `/etc/postfix/main.cf`.

2. Каким образом можно проверить корректность синтаксиса конфигурационном файле Postfix? 

- ` postfix check`

3. В каких параметрах конфигурации Postfix требуется внести изменения в
значениях для настройки возможности отправки писем не на локальный
хост, а на доменные адреса? 

- Для настройки возможности отправки
писем не на локальный хост, а на доменные адреса, вы можете
изменить параметры `myhostname` и `mydomain` в файле `main.cf`.

4. Приведите примеры работы с утилитой `mail` по отправке письма,
просмотру имеющихся писем, удалению письма. 

- Отправка письма: `echo Текст письма user@example.com`

- Просмотр имеющихся писем: `mail`

- Удаление письма: mail -d номер_письма

5. Приведите примеры работы с утилитой postqueue. Как посмотреть очередь
сообщений? Как определить число сообщений в очереди? Как отправить
все сообщения, находящиеся в очереди? Как удалить письмо из очереди? 

- Просмотр очереди сообщений: `postqueue -p`

- Определение числа сообщений в очереди: `postqueue -p | grep -c "^[A-F0-9]"`

- Отправка всех сообщений из очереди: `postqueue -f`

- Удаление письма из очереди: postsuper -d ID_СООБЩЕНИЯ