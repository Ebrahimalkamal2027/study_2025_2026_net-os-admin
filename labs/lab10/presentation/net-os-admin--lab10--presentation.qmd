---
## Author
author:
  name: Ибрахим Мохсейн Алькамаль
  degrees: Student (3 курс)
  orcid: ""
  email: 1032225432@pfur.ru
  affiliation:
    - name: Российский университет дружбы народов
      country: Российская Федерация
      postal-code: 117198
      city: Москва
      address: ул. Миклухо-Маклая, д. 6
## Title
title: Лабораторная работа №10
subtitle: "Дисциплина: Администрирование сетевых подсистем "
license: CC BY
date: today
date-format: "YYYY-MM-DD" # Example: 2025-09-06
---

# Цель работы

## Цель работы

- Приобретение практических навыков конфигурирования SMTP-сервера
- Настройка механизма аутентификации SMTP

# Выполнение лабораторной работы

## Настройка LMTP в Dovecote

- Выполнен вход под пользователем
- Переход в режим суперпользователя (`sudo -i`)
- Подтверждено приглашение `root@server`

![Переход в режим суперпользователя и мониторинг журнала maillog](image/1.png){#fig-1 width=70%}

---

- Запущен мониторинг `tail -f /var/log/maillog`
- Отслеживание событий Postfix и Dovecot в реальном времени

- В `dovecot.conf` добавлен протокол `lmtp`
- Установлено `protocols = imap pop3 lmtp`

![Добавление протокола lmtp в конфигурации Dovecot](image/2.png){#fig-2 width=70%}

---

- В `10-master.conf` настроен сервис `lmtp`
- Создан unix-сокет `/var/spool/postfix/private/dovecot-lmtp`
- Параметры: `user=postfix`, `group=postfix`, `mode=0600`

![Настройка сервиса lmtp и unix-сокета для взаимодействия с Postfix](image/3.png){#fig-3 width=70%}

---

- В Postfix задан `mailbox_transport = lmtp:unix:private/dovecot-lmtp`
- Доставка перенаправлена через LMTP-сокет

![Переопределение mailbox\_transport в Postfix](image/4.png){#fig-4 width=70%}

---

- В `10-auth.conf` задано `auth_username_format = %Ln`
- Аутентификация выполняется без доменной части

![Настройка формата имени пользователя в Dovecot](image/5.png){#fig-5 width=70%}

---

- Выполнен перезапуск `postfix` и `dovecot`
- Активированы обновлённые параметры

![Перезапуск служб Postfix и Dovecot](image/6.png){#fig-6 width=70%}

---

- С клиента отправлено письмо `LMTP test`
- Инициирована передача через SMTP

![Отправка тестового письма с клиента](image/8.png){#fig-8 width=70%}

---

- На сервере выполнена проверка `MAIL=~/Maildir/ mail`
- Отображено письмо «LMTP test»
- Подтверждена доставка через LMTP

![Просмотр содержимого Maildir и подтверждение доставки письма](image/9.png){#fig-9 width=70%}



## Настройка SMTP-аутентификации

- В `10-master.conf` настроена служба `service auth`
- Создан сокет `/var/spool/postfix/private/auth`
- Параметры: `user=postfix`, `group=postfix`, `mode=0660`
- Определён `unix_listener auth-userdb` с `mode=0600`

![Определение службы аутентификации service auth в Dovecot](image/10.png){#fig-10 width=70%}

---

- В Postfix задан `smtpd_sasl_type = dovecot`
- Указан `smtpd_sasl_path = private/auth`
- Настроен backend-аутентификатор Dovecot

![Настройка smtpd\_sasl\_type и smtpd\_sasl\_path в Postfix](image/11.png){#fig-11 width=70%}

---

- Настроен `smtpd_recipient_restrictions`
- Запрещён relay для неразрешённых направлений
- Включена проверка домена и получателя
- Разрешён доступ для `mynetworks`

- В `mynetworks` установлено `127.0.0.0/8`
- Разрешены только локальные соединения

- В `master.cf` включён `-o smtpd_sasl_auth_enable=yes`
- Аутентификация активирована на порту 25

![Модификация сервиса smtp в master.cf для включения SASL](image/12.png){#fig-12 width=70%}

---

- Перезапущены службы Postfix и Dovecot
- Активирована новая конфигурация

![Перезапуск служб Postfix и Dovecot](image/13.png){#fig-13 width=70%}

---

- На клиенте установлен пакет `telnet`
- Подготовлено тестирование SMTP

![Установка telnet на клиенте](image/14.png){#fig-14 width=70%}

---

- Сформирована строка `AUTH PLAIN` в base64
- Выполнено подключение по порту 25
- После `EHLO` объявлена поддержка `AUTH PLAIN`
- Ответ `235 Authentication successful`

![Тестирование SMTP-аутентификации через telnet](image/15.png){#fig-15 width=70%}



## Настройка SMTP over TLS

- Скопированы сертификат и ключ Dovecot
- В Postfix заданы `smtpd_tls_cert_file`, `smtpd_tls_key_file`
- Установлено `smtpd_tls_security_level = may`
- Активирована поддержка TLS

![Настройка TLS-параметров в Postfix](image/16.png){#fig-16 width=70%}

---

- В `master.cf` добавлен сервис `submission` (порт 587)
- Установлено `smtpd_tls_security_level=encrypt`
- Включена обязательная аутентификация

![Добавление сервиса submission в master.cf](image/18.png){#fig-18 width=70%}

---

- В firewall разрешена служба `smtp-submission`
- Выполнена перезагрузка firewall
- Перезапущен Postfix

![Настройка firewall и перезапуск Postfix](image/19.png){#fig-19 width=70%}

---

- Выполнено подключение `openssl s_client -starttls smtp`
- Установлено TLS-соединение
- Сервер объявил поддержку `AUTH PLAIN`

![Установление SMTP over TLS соединения через openssl](image/20.png){#fig-20 width=70%}

---

- Выполнена команда `AUTH PLAIN`
- Получен ответ `235 Authentication successful`
- Подтверждена работа SMTP over TLS

![Успешная SMTP-аутентификация через порт 587](image/21.png){#fig-21 width=70%}

---

- В Evolution настроен SMTP (587, STARTTLS)
- Отправлено письмо «test 5»

![Отправка письма через Evolution по SMTP over TLS](image/22.png){#fig-22 width=70%}

---

- На сервере выполнена проверка Maildir
- Отображено письмо «test 5»
- Подтверждена доставка через защищённое соединение

![Подтверждение доставки письма в Maildir](image/23.png){#fig-23 width=70%}



## Внесение изменений в настройки внутреннего

- В `/vagrant/provision/server` скопированы файлы `dovecot.conf`, `10-master.conf`, `10-auth.conf`, `master.cf`
- Подготовка конфигурации для provisioning

![Копирование конфигурационных файлов Dovecot и Postfix в каталог provision](image/24.png){#fig-24 width=70%}

---

- В `mail.sh` добавлена расширенная конфигурация SMTP
- Настроены параметры SASL, LMTP и TLS
- Добавлены ограничения `smtpd_recipient_restrictions` и `mynetworks`
- Выполнены `postfix set-permissions`, `restorecon`
- Реализован автоматический запуск служб

![Расширенная конфигурация SMTP-сервера в mail.sh (server)](image/25.png){#fig-25 width=70%}

---

- В `client/mail.sh` добавлена установка `telnet`
- Обеспечено тестирование SMTP при provisioning

![Добавление установки telnet в mail.sh (client)](image/26.png){#fig-26 width=70%}


# Выводы
## Выводы

- Настроена доставка через LMTP между Postfix и Dovecot
- Реализована SASL-аутентификация через Dovecot
- Исключено несанкционированное использование SMTP-relay
- Настроены ограничения `smtpd_recipient_restrictions` и `mynetworks`
- Реализована поддержка SMTP over TLS (порт 587)
- Подтверждена аутентификация через `telnet` и `openssl`
- Проверена доставка писем через Evolution
- Конфигурация интегрирована в provisioning Vagrant
- Обеспечена воспроизводимость настройки сервера
